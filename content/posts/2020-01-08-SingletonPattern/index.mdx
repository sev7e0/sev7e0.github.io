---
title: å•ä¾‹æ¨¡å¼-SingletonPattern
date: 2020-01-08 13:36:25
tags:
- è®¾è®¡æ¨¡å¼
---

## å®šä¹‰

Ensure a class has only one instance, and provide a global point of access to it.ï¼ˆç¡®ä¿æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å¯¹æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ã€‚ï¼‰

<!-- more -->

## è§’è‰²

`Singletonï¼šå•ä¾‹ç±»`

Singleton ç±»é€šè¿‡é€šè¿‡ private ä¿®é¥°çš„æ„é€ å‡½æ•°ä½¿è¯¥ç±»ä¸å¯ä»¥è¢«å¤–éƒ¨å®ä¾‹åŒ–ï¼Œä»è€Œä¿è¯å…¨å±€å”¯ä¸€çš„å®ä¾‹ã€‚

## ä½¿ç”¨åœºæ™¯

åœ¨ç³»ç»Ÿä¸­ï¼Œè¦æ±‚è¯¥ç±»çš„å¯¹è±¡æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªï¼Œå¤šä¸ªçš„æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°æ€§èƒ½ä¸‹é™ç­‰ä¸è‰¯ååº”ï¼Œæ­¤æ—¶å°±åº”è¯¥ä½¿ç”¨ Singleton ã€‚

- åœ¨è¦æ±‚ç”Ÿæˆå”¯ä¸€åºåˆ—å·çš„ç¯å¢ƒä¸­
- æ•°æ®åº“è¿æ¥ä»¥åŠé¢‘ç¹çš„ IO ç­‰æ¶ˆè€—å¤§é‡èµ„æºçš„ç¯å¢ƒä¸­ã€‚
- åœ¨æ•´ä¸ªé¡¹ç›®ä¸­éœ€è¦ä¸€ä¸ªå…±äº«è®¿é—®ç‚¹æˆ–å…±äº«æ•°æ®ï¼Œä¾‹å¦‚ä¸€ä¸ªWebé¡µé¢ä¸Šçš„è®¡æ•°å™¨ï¼Œå¯ä»¥ä¸ç”¨æŠŠæ¯æ¬¡åˆ·æ–°éƒ½è®°å½•åˆ°æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼ä¿æŒè®¡æ•°å™¨çš„å€¼ï¼Œå¹¶ç¡®ä¿æ˜¯çº¿ç¨‹å®‰å…¨çš„
- éœ€è¦å®šä¹‰å¤§é‡çš„é™æ€å¸¸é‡å’Œé™æ€æ–¹æ³•ï¼ˆå¦‚å·¥å…·ç±»ï¼‰çš„ç¯å¢ƒï¼Œå¯ä»¥é‡‡ç”¨å•ä¾‹æ¨¡å¼

## Singleton ä¼˜ç‚¹

- ç”±äºå•ä¾‹æ¨¡å¼åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜å¼€æ”¯ï¼Œç‰¹åˆ«æ˜¯ä¸€ä¸ªå¯¹è±¡éœ€è¦é¢‘ç¹åœ°åˆ›å»ºã€é”€æ¯æ—¶ï¼Œè€Œä¸”åˆ›å»ºæˆ–é”€æ¯æ—¶æ€§èƒ½åˆæ— æ³•ä¼˜åŒ–ï¼Œå•ä¾‹æ¨¡å¼çš„ä¼˜åŠ¿å°±éå¸¸æ˜æ˜¾ã€‚

- ç”±äºå•ä¾‹æ¨¡å¼åªç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥å‡å°‘äº†ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„äº§ç”Ÿéœ€è¦æ¯”è¾ƒå¤šçš„èµ„æºæ—¶ï¼Œå¦‚è¯»å–é…ç½®ã€äº§ç”Ÿå…¶ä»–ä¾èµ–å¯¹è±¡æ—¶ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨åº”ç”¨å¯åŠ¨æ—¶ç›´æ¥äº§ç”Ÿä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œç„¶åç”¨æ°¸ä¹…é©»ç•™å†…å­˜çš„æ–¹å¼æ¥è§£å†³ï¼ˆåœ¨Java EEä¸­é‡‡ç”¨å•ä¾‹æ¨¡å¼æ—¶éœ€è¦æ³¨æ„JVMåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰ã€‚

- å•ä¾‹æ¨¡å¼å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼Œä¾‹å¦‚ä¸€ä¸ªå†™æ–‡ä»¶åŠ¨ä½œï¼Œç”±äºåªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨å†…å­˜ä¸­ï¼Œé¿å…å¯¹åŒä¸€ä¸ªèµ„æºæ–‡ä»¶çš„åŒæ—¶å†™æ“ä½œã€‚

- å•ä¾‹æ¨¡å¼å¯ä»¥åœ¨ç³»ç»Ÿè®¾ç½®å…¨å±€çš„è®¿é—®ç‚¹ï¼Œä¼˜åŒ–å’Œå…±äº«èµ„æºè®¿é—®ï¼Œä¾‹å¦‚å¯ä»¥è®¾è®¡ä¸€ä¸ªå•ä¾‹ç±»ï¼Œè´Ÿè´£æ‰€æœ‰æ•°æ®è¡¨çš„æ˜ å°„å¤„ç†ã€‚

## Singleton çš„ç¼ºç‚¹

- å•ä¾‹æ¨¡å¼ä¸€èˆ¬æ²¡æœ‰æ¥å£ï¼Œæ‰©å±•å¾ˆå›°éš¾ï¼Œè‹¥è¦æ‰©å±•ï¼Œé™¤äº†ä¿®æ”¹ä»£ç åŸºæœ¬ä¸Šæ²¡æœ‰ç¬¬äºŒç§é€”å¾„å¯ä»¥å®ç°ã€‚å•ä¾‹æ¨¡å¼ä¸ºä»€ä¹ˆä¸èƒ½å¢åŠ æ¥å£å‘¢ï¼Ÿå› ä¸ºæ¥å£å¯¹å•ä¾‹æ¨¡å¼æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ï¼Œå®ƒè¦æ±‚â€œè‡ªè¡Œå®ä¾‹åŒ–â€ï¼Œå¹¶ä¸”æä¾›å•ä¸€å®ä¾‹ã€æ¥å£æˆ–æŠ½è±¡ç±»æ˜¯ä¸å¯èƒ½è¢«å®ä¾‹åŒ–çš„ã€‚å½“ç„¶ï¼Œåœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå•ä¾‹æ¨¡å¼å¯ä»¥å®ç°æ¥å£ã€è¢«ç»§æ‰¿ç­‰ï¼Œéœ€è¦åœ¨ç³»ç»Ÿå¼€å‘ä¸­æ ¹æ®ç¯å¢ƒåˆ¤æ–­ã€‚

- å•ä¾‹æ¨¡å¼å¯¹æµ‹è¯•æ˜¯ä¸åˆ©çš„ã€‚åœ¨å¹¶è¡Œå¼€å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœå•ä¾‹æ¨¡å¼æ²¡æœ‰å®Œæˆï¼Œæ˜¯ä¸èƒ½è¿›è¡Œæµ‹è¯•çš„ï¼Œæ²¡æœ‰æ¥å£ä¹Ÿä¸èƒ½ä½¿ç”¨mockçš„æ–¹å¼è™šæ‹Ÿä¸€ä¸ªå¯¹è±¡ã€‚

- å•ä¾‹æ¨¡å¼ä¸å•ä¸€èŒè´£åŸåˆ™æœ‰å†²çªã€‚ä¸€ä¸ªç±»åº”è¯¥åªå®ç°ä¸€ä¸ªé€»è¾‘ï¼Œè€Œä¸å…³å¿ƒå®ƒæ˜¯å¦æ˜¯å•ä¾‹çš„ï¼Œæ˜¯ä¸æ˜¯è¦å•ä¾‹å–å†³äºç¯å¢ƒï¼Œå•ä¾‹æ¨¡å¼æŠŠâ€œè¦å•ä¾‹â€å’Œä¸šåŠ¡é€»è¾‘èåˆåœ¨ä¸€ä¸ªç±»ä¸­

## æ³¨æ„äº‹é¡¹

åœ¨å•ä¾‹ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¦æ³¨æ„åœ¨å¹¶å‘çš„æƒ…å†µä¸‹**çº¿ç¨‹åŒæ­¥**é—®é¢˜ï¼é¿å…åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹äº§ç”Ÿå¤šä¸ªå•ä¾‹å¯¹è±¡ï¼Œè¿™æ ·å°±å¤±å»äº†å•ä¾‹çš„æœ¬è´¨ã€‚

å…·ä½“è§£å†³æ–¹æ¡ˆå°†ä¼šåœ¨å®ç°ä¸­å…·ä½“è¯´æ˜ï¼Œä¸»è¦ä¾èµ– Synchronize å®ç°åŒæ­¥ï¼Œå†å°±æ˜¯é€šè¿‡æšä¸¾ç±»ä¿è¯ã€‚

åŒæ—¶åœ¨é’ˆå¯¹å•ä¾‹å¯èƒ½ä¼šè¢«åå°„å’Œ[åºåˆ—åŒ–](http://www.hollischuang.com/archives/1144)ç ´åï¼Œå¯¼è‡´å•ä¾‹å¤±æ•ˆã€‚

å¦‚æœå•ä¾‹ç”±ä¸åŒçš„ç±»è£…è½½å™¨è£…å…¥ï¼Œé‚£ä¾¿æœ‰å¯èƒ½å­˜åœ¨å¤šä¸ªå•ä¾‹ç±»çš„å®ä¾‹ã€‚å‡å®šä¸æ˜¯è¿œç«¯å­˜å–ï¼Œä¾‹å¦‚ä¸€äº›servletå®¹å™¨å¯¹æ¯ä¸ªservletä½¿ç”¨å®Œå…¨ä¸åŒçš„ç±»è£…è½½å™¨ï¼Œè¿™æ ·çš„è¯å¦‚æœæœ‰ä¸¤ä¸ªservletè®¿é—®ä¸€ä¸ªå•ä¾‹ç±»ï¼Œå®ƒä»¬å°±éƒ½ä¼šæœ‰å„è‡ªçš„å®ä¾‹ã€‚å…·ä½“æŸ¥çœ‹[é¥¿æ±‰æ¨¡å¼]

## å…·ä½“å®ç°

å•ä¾‹æ¨¡å¼å®ç°æœ‰å¤šé‡æ–¹å¼ï¼Œå…¶ä¸­åŒ…æ‹¬çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹ä¸å®‰å…¨ä¸¤å¤§ç±»ã€‚

### çº¿ç¨‹ä¸å®‰å…¨

#### æ‡’æ±‰æ¨¡å¼

```java
public class Singleton {  
    private static Singleton instance;  
    private Singleton (){}  

    public static Singleton getInstance() { 
    //åœ¨ç”¨åˆ°æ—¶æ‰ä¼šè¢«åˆå§‹åŒ–
    if (instance == null) {  
        instance = new Singleton();  
    }  
    return instance;  
    }  
}  
```

### çº¿ç¨‹å®‰å…¨

#### æ‡’æ±‰æ¨¡å¼

è¿™ç§æ–¹å¼èƒ½å¤Ÿä¿è¯åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¿è¯å®‰å…¨ï¼Œè€Œä¸”ä¹Ÿèƒ½ä¿è¯åªæœ‰åœ¨ç”¨åˆ°æ—¶æ‰ä¼šè¢«åˆå§‹åŒ–ï¼Œä½†é—®é¢˜çš„å¯¹æ•´ä¸ªæ–¹æ³•åŒæ­¥æ€§èƒ½å¾ˆå·®ã€‚

```java
public class Singleton {  
    private static Singleton instance;  
    private Singleton (){}  
	//synchronizedè¿›è¡ŒåŒæ­¥
    public static synchronized Singleton getInstance() { 
	//åœ¨ç”¨åˆ°æ—¶æ‰ä¼šè¢«åˆå§‹åŒ–
    if (instance == null) {  
        instance = new Singleton();  
    }  
    return instance;  
    }  
}  
```

#### é¥¿æ±‰æ¨¡å¼

è¯¥ç§æ–¹å¼æ˜¯åœ¨ç±»è¢«åŠ è½½æ˜¯å°±å·²ç»è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå€ŸåŠ©äºç±»åŠ è½½æœºåˆ¶ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œé¿å…äº†åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹éœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œinstanceåœ¨ç±»è£…è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œè™½ç„¶å¯¼è‡´ç±»è£…è½½çš„åŸå› æœ‰å¾ˆå¤šç§ï¼Œåœ¨å•ä¾‹æ¨¡å¼ä¸­å¤§å¤šæ•°éƒ½æ˜¯è°ƒç”¨getInstanceæ–¹æ³•ï¼Œ ä½†æ˜¯ä¹Ÿä¸èƒ½ç¡®å®šæœ‰å…¶ä»–çš„æ–¹å¼ï¼ˆæˆ–è€…å…¶ä»–çš„é™æ€æ–¹æ³•ï¼‰å¯¼è‡´ç±»è£…è½½ï¼Œè¿™æ—¶å€™åˆå§‹åŒ–instanceæ˜¾ç„¶æ²¡æœ‰è¾¾åˆ°lazy loadingçš„æ•ˆæœã€‚

```java
public class Singleton {  
    private static Singleton instance = new Singleton();  
    private Singleton (){}  
    public static Singleton getInstance() {  
    return instance;  
    }  
}  
```

#### é™æ€å†…éƒ¨ç±»

è¿™ç§æ–¹å¼åŒæ ·åˆ©ç”¨äº†classloderçš„æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ–instanceæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒè·Ÿé¥¿æ±‰æ¨¡å¼ä¸åŒçš„æ˜¯ï¼ˆå¾ˆç»†å¾®çš„å·®åˆ«ï¼‰ï¼šé¥¿æ±‰æ¨¡å¼æ˜¯åªè¦Singletonç±»è¢«è£…è½½äº†ï¼Œé‚£ä¹ˆinstanceå°±ä¼šè¢«å®ä¾‹åŒ–ï¼ˆæ²¡æœ‰è¾¾åˆ°lazy loadingæ•ˆæœï¼‰ï¼Œè€Œè¿™ç§æ–¹å¼æ˜¯Singletonç±»è¢«è£…è½½äº†ï¼Œinstanceä¸ä¸€å®šè¢«åˆå§‹åŒ–ã€‚å› ä¸ºSingletonHolderç±»æ²¡æœ‰è¢«ä¸»åŠ¨ä½¿ç”¨ï¼Œåªæœ‰æ˜¾ç¤ºé€šè¿‡è°ƒç”¨getInstanceæ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºè£…è½½SingletonHolderç±»ï¼Œä»è€Œå®ä¾‹åŒ–instanceã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœå®ä¾‹åŒ–instanceå¾ˆæ¶ˆè€—èµ„æºï¼Œæˆ‘æƒ³è®©ä»–å»¶è¿ŸåŠ è½½ï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œæˆ‘ä¸å¸Œæœ›åœ¨Singletonç±»åŠ è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œå› ä¸ºæˆ‘ä¸èƒ½ç¡®ä¿Singletonç±»è¿˜å¯èƒ½åœ¨å…¶ä»–çš„åœ°æ–¹è¢«ä¸»åŠ¨ä½¿ç”¨ä»è€Œè¢«åŠ è½½ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®ä¾‹åŒ–instanceæ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œè¿™ç§æ–¹å¼ç›¸æ¯”é¥¿æ±‰æ¨¡å¼å°±æ˜¾å¾—å¾ˆåˆç†ã€‚

```java
public class Singleton{
    private Singleton(){}
    private static class SingletonHolder{
        private static final Singleton instance = new Singleton();
    }
    public static Singleton getInstance(){
        return SingletonHolder.instance;
    }
}
```

#### æšä¸¾å®ç°

ç›®å‰è¢«æ¨èæœ€å¤šçš„å®ç°æ–¹å¼ï¼ŒåŒæ ·åœ¨ç¬¬ä¸‰ç‰ˆçš„ã€ŠEffective Javaã€‹ä¸­è¢«å¤§ä½¬æ¨èçš„æ–¹å¼ï¼Œç”±äºæšä¸¾ç±»å‹çš„å¤©ç”Ÿçº¿ç¨‹å®‰å…¨çš„ä¼˜åŠ¿ï¼Œé¿å…äº†æ‰‹åŠ¨åŒæ­¥ï¼Œè€Œä¸”åœ¨å…¶ä»–å®ç°æ–¹å¼ä¸­å¯ä»¥è¢«ååºåˆ—åŒ–çš„é—®é¢˜ä¹Ÿå¾—åˆ°äº†è§£å†³ã€‚å¢™è£‚æ¨èã€‚

```java
public emum Singleton{
    INSTANCE;
    public void udf(){
    }
}
```

#### åŒé‡æ£€æŸ¥ğŸ”’å®ç°

```java
public class Singleton {  
    private volatile static Singleton singleton;  
    private Singleton (){}  
    public static Singleton getSingleton() {  
    if (singleton == null) {  
        synchronized (Singleton.class) {  
        if (singleton == null) {  
            singleton = new Singleton();  
        }  
        }  
    }  
    return singleton;  
    }  
}
```

## æ€»ç»“

å•ä¾‹æ¨¡å¼ä½œä¸ºæœ€æ™®éçš„è®¾è®¡æ¨¡å¼ï¼Œæ— è®ºåœ¨å®è·µè¿˜æ˜¯é¢è¯•ä¸­éƒ½ä¼šç»å¸¸é‡åˆ°ï¼Œå¯å…·ä½“åˆ†ä¸ºäº”ç§ï¼Œæ‡’æ±‰æ¨¡å¼ã€é¥¿æ±‰æ¨¡å¼ã€é™æ€å†…éƒ¨ç±»æ¨¡å¼ã€æšä¸¾æ¨¡å¼ã€åŒé‡æ£€æŸ¥ğŸ”’æ¨¡å¼ã€‚éœ€è¦é‡ç‚¹æŒæ¡æšä¸¾æ¨¡å¼ã€åŒé‡æ£€æŸ¥ğŸ”’æ¨¡å¼

## å‚è€ƒèµ„æ–™

> è®¾è®¡æ¨¡å¼
> è®¾è®¡æ¨¡å¼ä¹‹ç¦…
> [[è½¬+æ³¨]å•ä¾‹æ¨¡å¼çš„ä¸ƒç§å†™æ³•-HollisChuang's Blog](http://www.hollischuang.com/archives/205)
> [æ·±åº¦åˆ†æJavaçš„æšä¸¾ç±»å‹â€”-æšä¸¾çš„çº¿ç¨‹å®‰å…¨æ€§åŠåºåˆ—åŒ–é—®é¢˜-HollisChuang's Blog](http://www.hollischuang.com/archives/197)